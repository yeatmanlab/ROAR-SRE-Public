---
title: "ROAR-SRE-WJ-Analysis"
author: "Jasmine Tran"
date:  "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    theme: cosmo
    highlight: tango
---

# Load Packages

Let's first load the packages that we need for this chapter.

```{r, message=FALSE, warning = FALSE, echo = FALSE}
library(knitr)
library(stringr)
library(ggpubr)
library(mirt)
library(kableExtra)
library(tidyverse)
library(purrr)
library(plyr)
library(ggplot2)
library(viridis)
library(ggsci)
library(wesanderson)
library(dplyr)
library(plotrix)
opts_knit$set(root.dir = "~/Documents/roar-analysis")
```

## Settings
```{r echo = FALSE}
# sets how code looks in knitted document
opts_chunk$set(comment = "")
# suppresses warning about grouping 
options(dplyr.summarise.inform = F)
```

# Data 

## Data location: https://drive.google.com/drive/u/1/folders/0AAol-yxLe1sfUk9PVA

## Data Loading (LMB participants)
```{r}
# data from study 1 (LMB participants)
df.raw <- read.csv("~/Documents/roar-analysis/data/lmb_F1_C3_sre_data.csv")
df.wj.raw <- read.csv("~/Documents/roar-analysis/data/lmb_F1_C3_wj_srf_data.csv")
```

## Data Loading (BRSSD participants)
```{r}
# data from study 2 (brssd validation)
df.sre.brs.raw <- read.csv("~/Documents/roar-analysis/data/brs_sre_data_runs_fall_23.csv")
df.wj.brs.raw <- read.csv("~/Documents/roar-analysis/data/brs_srf_towre_data_fall_23.csv")
```

## Data Cleaning & Wrangling

### Processing raw SRE trials from JsPsych
```{r}
df.lmb.cleaned <- df.raw %>% 
  filter(grepl("rc-", pid), 
         task == "test_response", 
         completed == "True") %>% 
  mutate(correct = as.numeric(correct),
         gradeResponse = str_extract(userInfo, "(?<=grade': ').*?(?='\\})"))
```

```{r}
# filtering for completed runs and the correct participants
df.brs.sre.cleaned <- df.sre.brs.raw %>% 
  filter(grepl("brs-", user.assessmentPid), 
         completed == "True") %>%
  select("pid" = user.assessmentPid,
         runId, 
         "sreScore" = scores.computed.composite.sreScore) %>%
  mutate(source = "BRSSD")
```

```{r}
# determinig which participants are guessing with low accuracy and very fast response times
df.lmb.sre.filtered <- df.lmb.cleaned %>%
  group_by(pid, runId, blockId) %>%
  dplyr::summarise(medianRT = median(rt),
                   correct = sum(correct),
                   attempted = n(), 
                   incorrect = attempted - correct, 
                   pCorr = correct/attempted) %>%
  select(-correct, -attempted, -incorrect) %>%
  pivot_wider(names_from = blockId, values_from = c("medianRT", "pCorr")) %>%
  filter((medianRT_lab > 1000 & pCorr_lab > 0.60) | (medianRT_ai > 1000 & pCorr_ai > 0.60)) %>%
  mutate(keep = 1, 
         source = "LMB") %>%
  ungroup() %>%
  select(pid, keep, source)
```

```{r}
# filtering out guessing participants
df.lmb.sre.runs <- df.lmb.cleaned %>%
  mutate(correct_new = ifelse(correct == 0, -1, 1)) %>%
  group_by(pid, runId, blockId) %>%
  dplyr::summarise(sreScore = sum(correct_new)) %>% 
  filter(blockId == "lab") %>%
  select(-blockId) %>%
  left_join(df.lmb.sre.filtered, by="pid") %>%
  filter(keep == 1) %>%
  select(-keep)
```

### Merging the SRE data for LMB and BRSSD participants
```{r}
df.combined.sre.scores <- rbind(df.brs.sre.cleaned, df.lmb.sre.runs)
```

### Removing unused columns from validation assessment dataframes
```{r}
df.wj.cleaned <- df.wj.raw %>%
  select(-redcapId) %>%
  mutate(towreSweRaw = NA,
         towrePdeRaw = NA)
```

```{r}
df.wj.brs.cleaned <- df.wj.brs.raw %>%
  select(-date) %>%
  mutate(mffScore = NA)
```

### Merging the WJ/TOWRE data for LMB and BRSSD participants
```{r}
df.combined.wj.scores <- rbind(df.wj.cleaned, df.wj.brs.cleaned)
```

### Combining SRE and WJ/TOWRE scores for final analysis dataframe
```{r}
df.sre.validtion.analysis <- df.combined.sre.scores %>%
  left_join(df.combined.wj.scores, by="pid") %>%
  filter(!is.na(srfCorrect)) %>%
  mutate(srfScore = srfCorrect - srfIncorrect) %>%
  select(-srfCorrect, -srfIncorrect, -runId)
```

# Data Analysis

## Inspecting SRE vs. WJ SRF correlations 
```{r}
ggplot(df.sre.validtion.analysis, mapping = aes(x = sreScore,
                     y = srfScore, color=source)) + 
  geom_point() + 
  labs(x = "SRE-Fixed score (correct - incorrect)",
       y = "WJ SRF score (correct - incorrect)",
       color = "Study") +
  #scale_color_viridis(option = 'viridis') +
  geom_smooth(method = "lm", color="black") +
  stat_cor(cor.coef.name = 'r', aes(label = ..r.label..), color = "black", 
           geom = "label", hjust = -0.3, vjust = 1) +
  theme_light() +
  theme(text=element_text(family="Avenir", size=12)) 
```

## Inspecting SRE vs. TOWRE SWE & PDE correlations 
```{r}
ggplot(df.sre.validtion.analysis, mapping = aes(x = sreScore,
                     y = towreSweRaw)) + 
  geom_point() + 
  labs(x = "SRE-Fixed score (correct - incorrect)",
       y = "TOWRE SWE score (real words)") +
  #scale_color_viridis(option = 'viridis') +
  geom_smooth(method = "lm", color="black") +
  stat_cor(cor.coef.name = 'r', aes(label = ..r.label..), color = "black", 
           geom = "label", hjust = -0.3, vjust = 1) +
  theme_light() +
  theme(text=element_text(family="Avenir", size=12)) 

ggplot(df.sre.validtion.analysis, mapping = aes(x = sreScore,
                     y = towrePdeRaw)) + 
  geom_point() + 
  labs(x = "SRE-Fixed score (correct - incorrect)",
       y = "TOWRE PDE score (pseudo words)") +
  #scale_color_viridis(option = 'viridis') +
  geom_smooth(method = "lm", color="black") +
  stat_cor(cor.coef.name = 'r', aes(label = ..r.label..), color = "black", 
           geom = "label", hjust = -0.3, vjust = 1) +
  theme_light() +
  theme(text=element_text(family="Avenir", size=12)) 
```

## Inspecting SRE vs. WJ MFF correlations 
```{r}
ggplot(df.sre.validtion.analysis, mapping = aes(x = sreScore,
                     y = mffScore)) + 
  geom_point() + 
  labs(x = "SRE-Fixed score (correct - incorrect)",
       y = "WJ MFF score") +
  #scale_color_viridis(option = 'viridis') +
  geom_smooth(method = "lm", color="black") +
  stat_cor(cor.coef.name = 'r', aes(label = ..r.label..), color = "black", 
           geom = "label", hjust = -0.3, vjust = 1) +
  theme_light() +
  theme(text=element_text(family="Avenir", size=12)) 
```